# 域名健康检查功能

系统提供了完整的域名健康检查功能，可以自动检测租户域名的配置状态。

## 🎯 功能说明

### 自动检查项目

1. **DNS 配置检查**
   - 检查域名是否已配置 DNS 记录
   - 验证域名是否指向正确的服务器 IP
   - 识别本地开发环境（localhost）

2. **域名可访问性检查**
   - 测试域名是否可以正常访问
   - 检查 HTTP 和 HTTPS 连接
   - 记录响应状态

3. **SSL 证书检查**
   - 检测是否配置了 SSL 证书
   - 验证证书有效性
   - 标识证书状态

## 📊 状态说明

### DNS 状态

| 状态 | 说明 | 图标 |
|------|------|------|
| 已配置 | DNS 正确指向服务器 IP | ✅ |
| 本地环境 | 域名指向 127.0.0.1（开发环境） | 🏠 |
| 未配置 | 域名没有 DNS 记录 | ⚠️ |
| 配置错误 | DNS 指向错误的 IP 地址 | ❌ |
| 检查失败 | 检查过程出错 | ❌ |
| 未检查 | 还未进行检查 | ⏳ |

### SSL 状态

| 状态 | 说明 |
|------|------|
| 已配置 | SSL 证书有效 |
| 未配置 | 没有 SSL 证书 |
| 证书无效 | SSL 证书存在问题 |
| 证书过期 | SSL 证书已过期 |

### 可访问性状态

- ✅ **可访问**: 域名可以正常访问
- ❌ **不可访问**: 域名无法访问

## 🔧 使用方法

### 1. 单个租户域名检查

**位置**: 租户编辑页面

1. 进入中央管理后台 `/admin`
2. 打开任一租户的编辑页面
3. 点击右上角 **"检查域名状态"** 按钮
4. 系统会自动检查该租户的所有域名
5. 检查结果会以通知形式显示

### 2. 批量检查所有域名

**位置**: 租户列表页面

1. 进入租户列表页面
2. 点击右上角 **"检查所有域名"** 按钮
3. 确认操作
4. 系统会检查所有租户的所有域名
5. 完成后显示检查统计

### 3. 查看域名状态

**位置**: 租户编辑页面 - 域名配置区域

编辑租户时，在域名列表中可以看到：

- 域名项目标题带状态图标（✅🏠⚠️❌⏳）
- 展开域名项可查看详细状态信息：
  - DNS 状态
  - SSL 状态
  - 可访问性
  - 最后检查时间
  - 详细检查消息

## 💻 配置说明

### 环境变量配置

在 `.env` 文件中配置服务器 IP（可选）：

```env
# 服务器公网 IP（生产环境）
SERVER_IP=123.45.67.89
```

如果不配置，系统会尝试自动获取。

### 本地开发环境

在本地开发时：
- 域名指向 `127.0.0.1` 会被标记为 **本地环境** 🏠
- 这是正常状态，用于本地测试

### 生产环境

在生产环境中：
- 域名应该指向服务器的公网 IP
- 状态应该显示为 **已配置** ✅
- 建议配置 SSL 证书

## 🔍 检查流程

### 检查步骤

```
1. DNS 解析检查
   ↓
2. 比对服务器 IP
   ↓
3. HTTPS 可访问性测试
   ↓
4. HTTP 可访问性测试（如果 HTTPS 失败）
   ↓
5. 更新域名状态记录
   ↓
6. 显示检查结果
```

### 检查超时

- DNS 解析: 系统默认超时
- HTTP/HTTPS 请求: 5秒超时

## 📋 数据库字段

domains 表新增字段：

| 字段 | 类型 | 说明 |
|------|------|------|
| dns_status | string | DNS 配置状态 |
| ssl_status | string | SSL 证书状态 |
| is_accessible | boolean | 是否可访问 |
| last_checked_at | timestamp | 最后检查时间 |
| check_message | text | 检查详细信息 |

## 🎨 界面展示

### 域名列表显示

```
✅ client-domain.com
   DNS: 已配置 | SSL: 已配置 | 可访问
   最后检查: 2分钟前
   DNS 已正确配置，指向 123.45.67.89

🏠 tenant1.localhost
   DNS: 本地环境 | SSL: 未配置 | 可访问
   最后检查: 刚刚
   域名指向本地（开发环境）

⚠️ new-domain.com
   DNS: 未配置 | SSL: 未配置 | 不可访问
   最后检查: 30秒前
   域名未配置 DNS 记录或无法解析
```

## 🔄 自动化检查（可选）

### 定时任务

创建定时任务自动检查域名：

编辑 `app/Console/Kernel.php`：

```php
protected function schedule(Schedule $schedule)
{
    // 每天凌晨 2 点检查所有域名
    $schedule->call(function () {
        $healthCheck = app(DomainHealthCheckService::class);
        $tenants = \App\Models\Tenant::with('domains')->get();

        foreach ($tenants as $tenant) {
            $healthCheck->checkTenantDomains($tenant);
        }
    })->dailyAt('02:00');
}
```

### 手动命令

创建 Artisan 命令手动检查：

```bash
php artisan tenants:check-domains
```

## 📱 通知和提醒

### 检查完成通知

检查完成后会显示：
- 成功通知：绿色
- 警告通知：黄色
- 错误通知：红色

### 详细信息

通知中包含：
- 检查的域名列表
- 每个域名的状态
- SSL 配置情况

## 🔧 故障排查

### 问题：DNS 显示"未配置"

**原因**:
- 域名还没有添加 DNS 记录
- DNS 记录还未生效（需要等待传播）

**解决**:
1. 在域名注册商处添加 A 记录
2. 等待 DNS 传播（通常 5分钟-48小时）
3. 重新检查

### 问题：DNS 显示"配置错误"

**原因**:
- DNS 指向了错误的 IP 地址

**解决**:
1. 检查 A 记录是否指向正确的服务器 IP
2. 更新 DNS 记录
3. 等待生效后重新检查

### 问题：显示"不可访问"

**原因**:
- Nginx 未正确配置
- 防火墙阻止访问
- 服务器未启动
- 域名 DNS 未生效

**解决**:
1. 检查 Nginx 是否运行: `brew services list | grep nginx`
2. 检查防火墙设置
3. 验证 DNS 是否生效: `ping domain.com`
4. 查看 Nginx 错误日志

### 问题：SSL 显示"未配置"

**原因**:
- 还没有安装 SSL 证书

**解决**:
1. 使用 Let's Encrypt 申请免费证书
2. 配置 Nginx SSL
3. 重新检查

## 🚀 最佳实践

### 1. 创建租户后立即检查

```
1. 创建租户
2. 配置域名
3. 点击"检查域名状态"
4. 根据检查结果配置 DNS
5. 再次检查确认
```

### 2. 定期检查

- 建议每周检查一次所有域名
- 发现问题及时处理
- 关注 SSL 证书过期

### 3. 配置监控

- 配置定时任务自动检查
- 异常时发送邮件通知
- 记录检查历史

## 📚 相关文档

- [README.md](README.md) - 项目总览
- [CUSTOM_DOMAINS.md](CUSTOM_DOMAINS.md) - 独立域名配置
- [NGINX_SETUP.md](NGINX_SETUP.md) - Nginx 配置

---

需要帮助？检查域名状态后查看详细错误信息。
